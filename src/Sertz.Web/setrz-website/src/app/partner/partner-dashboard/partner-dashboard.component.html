<div class="dashboard-container">
  <!-- Header -->
  <header class="dashboard-header">
    <div class="logo">Zeeroni</div>
    <div class="user-profile">
      <img src="https://via.placeholder.com/40" alt="User Avatar" class="avatar" />
      <button class="logout-button" (click)="logout()">Logout</button>
    </div>
  </header>

  <!-- Main Content -->
  <main class="dashboard-main">
    <h2>Video Survey Upload</h2>

    <!-- Upload Options Area -->
    <div class="upload-options-area">
      <div class="upload-option" (click)="fileUploadInput.click()">
        <input
          type="file"
          #fileUploadInput
          (change)="onFileSelected($event)"
          hidden
          accept="video/*"
        />
        <p>Upload a video file</p>
        <p class="small-text">Select an existing video from your device.</p>
      </div>

      <div class="upload-option" (click)="cameraInput.click()">
        <input
          type="file"
          #cameraInput
          (change)="onFileSelected($event)"
          hidden
          accept="video/*"
          capture="environment"
        />
        <p>Open Camera</p>
        <p class="small-text">Record a new video directly.</p>
      </div>
    </div>

    <!-- New Upload Preview and Confirmation Section -->
    <div *ngIf="selectedFile" class="upload-preview-container">
      <h4 class="preview-header">Upload Confirmation</h4>
      <div class="preview-content">
        <div class="video-preview">
          <video [src]="filePreviewUrl" controls></video>
        </div>
        <div class="upload-form">
          <div class="form-group">
            <label for="customFileName">File Name</label>
            <input
              id="customFileName"
              type="text"
              [(ngModel)]="customFileName"
              placeholder="Enter a custom name for your video"
              [disabled]="isUploading"
            />
          </div>
          <div class="upload-actions">
            <button
              class="action-button primary-button"
              (click)="onUpload()"
              [disabled]="isUploading || !customFileName"
            >
              {{ isUploading ? 'Uploading...' : 'Confirm & Upload' }}
            </button>
            <button
              class="action-button cancel-button"
              (click)="cancelSelection()"
              [disabled]="isUploading"
            >
              Cancel
            </button>
          </div>
        </div>
      </div>
      <!-- Progress Bar and Status -->
      <div *ngIf="isUploading" class="upload-progress-section">
        <p class="status-message">{{ uploadStatusMessage }}</p>
        <div class="progress-bar-container">
          <div class="progress-bar" [style.width.%]="uploadProgress"></div>
        </div>
      </div>
    </div>

    <!-- Survey List -->
    <div class="survey-list">
      <h3>Recent Uploads</h3>
      <div *ngIf="isLoadingUploads" class="loading-spinner-container">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Loading uploads...</span>
        </div>
        <p>Loading uploads...</p>
      </div>
      <ng-container *ngIf="!isLoadingUploads">
        <div class="upload-item-card" *ngFor="let upload of uploads">
          <div class="item-details">
            <span class="video-name">{{ upload.fileName || upload.videoName }}</span>
            <span class="timestamp">{{ upload.createdTimestamp | date: 'short' }}</span>
          </div>
          <div class="item-status">
            <span class="status-badge" [ngClass]="getStatusClass(upload.status)">
              {{ upload.status }}
            </span>
            <div class="progress-bar-container" *ngIf="upload.status === 'Pending' || upload.status === 'Processing'">
              <div class="progress-bar" [style.width.%]="upload.progress"></div>
            </div>
          </div>
          <div class="item-actions">
            <button
              *ngIf="upload.status === 'Completed'"
              class="action-button primary-button"
              (click)="openDigitalManifest(upload.uploadId)"
            >
              Get Digital Manifest
            </button>
            <button
              *ngIf="upload.status === 'Failed'"
              class="action-button retry-button"
              (click)="retryUpload(upload.uploadId)"
            >
              Retry
            </button>
          </div>
        </div>
        <p *ngIf="uploads.length === 0" class="no-uploads">No uploads yet.</p>
      </ng-container>
    </div>
  </main>
</div>

<!-- Digital Manifest Modal -->
<app-digital-manifest-modal
  *ngIf="isModalOpen"
  [manifestData]="selectedManifest"
  [isLoading]="isLoadingManifest"
  (closeModal)="closeDigitalManifest()"
>
</app-digital-manifest-modal>
